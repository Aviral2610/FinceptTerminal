import{B as L}from"./ccxt-vendor-DQA7zUGY.js";import{c as O,i as S,a as T,S as I}from"./net-shim-CnjyueI7.js";import*as g from"tls";import{a as E}from"./assert-shim-BDCRrvWb.js";import{A as N}from"./index-DCZNNqZp.js";import"./react-vendor-9XN-Nagm.js";import"./index-BJIVZg5l.js";import"./index-DbK550uc.js";import"./index-DrIlkRko.js";function R(t){return new Promise((o,e)=>{let r=0;const a=[];function n(){const i=t.read();i?u(i):t.once("readable",n)}function c(){t.removeListener("end",p),t.removeListener("error",l),t.removeListener("close",h),t.removeListener("readable",n)}function h(i){}function p(){}function l(i){c(),e(i)}function u(i){a.push(i),r+=i.length;const f=L.concat(a,r);if(f.indexOf(`\r
\r
`)===-1){n();return}const $=f.toString("ascii").split(`\r
`),v=$.shift();if(!v)throw new Error("No header received");const C=v.split(" "),b=+C[1],A=C.slice(2).join(" "),m={};for(const d of $){if(!d)continue;const x=d.indexOf(":");if(x===-1)throw new Error(`Invalid header: "${d}"`);const P=d.slice(0,x).toLowerCase(),w=d.slice(x+1).trimStart(),y=m[P];typeof y=="string"?m[P]=[y,w]:Array.isArray(y)?y.push(w):m[P]=w}c(),o({connect:{statusCode:b,statusText:A,headers:m},buffered:f})}t.on("error",l),t.on("close",h),t.on("end",p),n()})}class B extends N{constructor(o,e){super(e),this.options={path:void 0},this.proxy=typeof o=="string"?new URL(o):o,this.proxyHeaders=e?.headers??{};const r=(this.proxy.hostname||this.proxy.host).replace(/^\[|\]$/g,""),a=this.proxy.port?parseInt(this.proxy.port,10):this.secureProxy?443:80;this.connectOpts={ALPNProtocols:["http/1.1"],...e?H(e,"headers"):null,host:r,port:a}}get secureProxy(){return k(this.proxy.protocol)}async connect(o,e){const{proxy:r,secureProxy:a}=this;if(!e.host)throw new TypeError('No "host" provided');let n;a?n=g.connect(this.connectOpts):n=O(this.connectOpts);const c=typeof this.proxyHeaders=="function"?this.proxyHeaders():{...this.proxyHeaders},h=S(e.host)?`[${e.host}]`:e.host;let p=`CONNECT ${h}:${e.port} HTTP/1.1\r
`;if(r.username||r.password){const s=`${decodeURIComponent(r.username)}:${decodeURIComponent(r.password)}`;c["Proxy-Authorization"]=`Basic ${L.from(s).toString("base64")}`}c.Host=`${h}:${e.port}`,c["Proxy-Connection"]||(c["Proxy-Connection"]=this.keepAlive?"Keep-Alive":"close");for(const s of Object.keys(c))p+=`${s}: ${c[s]}\r
`;const l=R(n);n.write(`${p}\r
`);const{connect:u,buffered:i}=await l;if(o.emit("proxyConnect",u),this.emit("proxyConnect",u,o),u.statusCode===200){if(o.once("socket",U),e.secureEndpoint){const s=e.servername||e.host;return g.connect({...H(e,"host","path","port"),socket:n,servername:T(s)?void 0:s})}return n}n.destroy();const f=new I({writable:!1});return f.readable=!0,o.once("socket",s=>{E(s.listenerCount("data")>0),s.push(i),s.push(null)}),f}}B.protocols=["http","https"];function U(t){t.resume()}function k(t){return typeof t=="string"?/^https:?$/i.test(t):!1}function H(t,...o){const e={};let r;for(r in t)o.includes(r)||(e[r]=t[r]);return e}export{B as HttpsProxyAgent};
